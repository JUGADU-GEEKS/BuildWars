from pymongo import MongoClient
from werkzeug.security import generate_password_hash, check_password_hash
from dotenv import load_dotenv
import os
load_dotenv()

MONGO_URI = os.getenv("MONGO_URI")
print(f"Loaded MONGO_URI: {MONGO_URI}")
client = MongoClient(MONGO_URI)
db = client['Student-Community']
users_collection = db['users']

class User:
    def __init__(self, data):
        self.full_name = data.get('full_name')
        self.enrollment = data.get('enrollment')
        self.email = data.get('email')
        self.contact = data.get('contact')
        self.college = data.get('college')
        self.course = data.get('course')
        self.branch = data.get('branch')
        self.section = data.get('section')
        self.password = generate_password_hash(data.get('password'))
        self.profile_photo = 'data:image/jpeg;base64,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'
        self.otp = None
        self.isVerified = False

    def save_to_db(self):
        if users_collection.find_one({"email": self.email}):
            return False, "Email already exists!"
        users_collection.insert_one(self.__dict__)
        return True, "Account created! Please verify your email."

    @staticmethod
    def verify_user(email, otp):
        user = users_collection.find_one({"email": email})
        if user and user['otp'] == otp:
            users_collection.update_one({"email": email}, {"$set": {"is_verified": True}})
            return True
        return False

    @staticmethod
    def check_password(email, password):
        user = users_collection.find_one({"email": email})
        return user and check_password_hash(user['password'], password)
    
    def upload_image(self, image_address):
        self.profile_photo=image_address

    @staticmethod
    def get_data(email):
       return users_collection.find_one({"email": email})
    
    def update_otp(self, otp):
        self.otp = otp
        users_collection.update_one({"email": self.email}, {"$set": {"otp": otp}})
